From 71f0cdb9ac82c6f647bf94167fb185f8c4f976bc Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Mon, 10 Dec 2018 20:57:25 +0800
Subject: [PATCH] kmssink: Support save/restore original crtc

Port from weston's compositor-drm.c

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 sys/kms/gstkmssink.c | 20 ++++++++++++++++++++
 sys/kms/gstkmssink.h |  2 ++
 2 files changed, 22 insertions(+)

diff --git a/sys/kms/gstkmssink.c b/sys/kms/gstkmssink.c
index 7eb54ab..3152e1f 100755
--- a/sys/kms/gstkmssink.c
+++ b/sys/kms/gstkmssink.c
@@ -409,6 +409,20 @@ get_drm_caps (GstKMSSink * self)
   return TRUE;
 }
 
+static void
+restore_original_crtc (GstKMSSink * self)
+{
+  if (!self->original_crtc)
+    return;
+
+  drmModeSetCrtc(self->fd, self->original_crtc->crtc_id,
+      self->original_crtc->buffer_id, self->original_crtc->x,
+      self->original_crtc->y, (uint32_t *) &self->conn_id, 1,
+      &self->original_crtc->mode);
+  drmModeFreeCrtc(self->original_crtc);
+  self->original_crtc = NULL;
+}
+
 static gboolean
 configure_mode_setting (GstKMSSink * self, GstVideoInfo * vinfo)
 {
@@ -455,6 +469,9 @@ configure_mode_setting (GstKMSSink * self, GstVideoInfo * vinfo)
   if (!mode)
     goto mode_failed;
 
+  if (!self->original_crtc)
+    self->original_crtc = drmModeGetCrtc(self->fd, self->crtc_id);
+
   err = drmModeSetCrtc (self->fd, self->crtc_id, fb_id, 0, 0,
       (uint32_t *) & self->conn_id, 1, mode);
   if (err)
@@ -500,6 +517,7 @@ mode_failed:
   }
 modesetting_failed:
   {
+    restore_original_crtc(self);
     GST_ERROR_OBJECT (self, "Failed to set mode: %s", strerror (errno));
     goto bail;
   }
@@ -704,6 +722,7 @@ bail:
     drmModeFreeResources (res);
 
   if (!ret && self->fd >= 0) {
+    restore_original_crtc (self);
     drmClose (self->fd);
     self->fd = -1;
   }
@@ -797,6 +816,7 @@ gst_kms_sink_stop (GstBaseSink * bsink)
   gst_poll_fd_init (&self->pollfd);
 
   if (self->fd >= 0) {
+    restore_original_crtc (self);
     drmClose (self->fd);
     self->fd = -1;
   }
diff --git a/sys/kms/gstkmssink.h b/sys/kms/gstkmssink.h
index 92d51aa..71eb50b 100755
--- a/sys/kms/gstkmssink.h
+++ b/sys/kms/gstkmssink.h
@@ -88,6 +88,8 @@ struct _GstKMSSink {
   /* reconfigure info if driver doesn't scale */
   GstVideoRectangle pending_rect;
   gboolean reconfigure;
+
+  drmModeCrtcPtr original_crtc;
 };
 
 struct _GstKMSSinkClass {
-- 
2.11.0


From eee7196176fcc6f24040ab0f2f9898beac796171 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Tue, 11 Dec 2018 10:40:55 +0800
Subject: [PATCH 5/7] gsttools: videooverlay: Make holes for kmssink on wayland

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 src/gsttools/qgstreamervideooverlay.cpp | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/src/gsttools/qgstreamervideooverlay.cpp b/src/gsttools/qgstreamervideooverlay.cpp
index 4d8fb44..1c126e1 100644
--- a/src/gsttools/qgstreamervideooverlay.cpp
+++ b/src/gsttools/qgstreamervideooverlay.cpp
@@ -294,6 +294,17 @@ void QGstreamerVideoOverlay::setWindowHandle_helper(WId id)
         gst_video_overlay_set_render_rectangle(overlay, pos.x() + m_rect.x(),
                 pos.y() + m_rect.y(), m_rect.width(), m_rect.height());
 
+        // HACK: Let wayland server to make a hole for kmssink
+        if (!strstr(GST_ELEMENT_NAME(m_videoSink), "kmssink"))
+            goto out;
+
+        struct wl_region *region = wl_compositor_create_region(compositor);
+        wl_region_add(region, pos.x() + m_rect.x(), pos.y() + m_rect.y(),
+                m_rect.width(), m_rect.height());
+        wl_region_add(region, -1, -1, 1, 1);
+        wl_surface_set_opaque_region(surface, region);
+        wl_region_destroy(region);
+
         goto out;
     }
 #endif // ENABLE_WAYLAND_PLATFORM
-- 
2.11.0

